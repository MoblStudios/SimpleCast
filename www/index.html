<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/styles.css" />
        <title>SimpleCast</title>
    </head>
    <body class="display-high">
        <div id="wrapper" class="expanded-top">
            
            <div id="today"></div>
            <div class="forecast" id="forecast"></div>
        
            <div class="settings">
                <span class="btn">Close</span>
                location<br />
                which things shown where?<br />
                credits
            </div>
        </div>
        <script id="today-template" type="text/x-handlebars-template">
            <div id="top-wrap" class="str-0"> 
                <div class="forecast-today">
                    <i class="icon" data-icon="{{icon}}"></i>
                    <ul class="day-meta">
                        <li class="meta-1 meta-high">{{high}}&deg;</li>
                        <li class="meta-display"> / </li>
                        <li class="meta-1 meta-high">{{low}}&deg;</li>
                        <li class="meta-1 meta-rain">{{perc}}%</li>
                    </ul>
                    <span class="date"><strong>{{weekDay}}</strong> {{month}}, {{day}}</span>
                </div>
                
                <ul class="menu-focus">
                    <li class="meta-1 meta-high">High</li>
                    <li class="meta-2 meta-low">Low</li>
                    <li class="meta-3 meta-rain">Rain</li>
                </ul>
            </div> 
        </script>
        <script id="forecast-template" type="text/x-handlebars-template">
            <ol class="forecast-days" data-temp-high="{{almanac.temp_high.normal.F}}" data-temp-low="{{almanac.temp_low.normal.F}}">
                {{#forecast}}
                    <li class="str-0">
                        <i class="icon" data-icon="{{icon}}"></i>
                        <span class="date"><strong>{{weekDay}}</strong> {{month}}, {{day}}</span>
                        <ul class="day-meta">
                            <li class="meta-1 meta-high">{{high}}&deg;</li>
                            <li class="meta-2 meta-low">{{low}}&deg;</li>
                            <li class="meta-3 meta-rain">{{perc}}%</li>
                        </ul>
                    </li>
                {{/forecast}}
            </ol>
        </script>
        <script type="text/javascript" src="cordova-2.0.0.js"></script>
        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/handlebars.min.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
        $(function(){
                    $(window).scroll(function () { 
            
            var scrollTop = $(window).scrollTop();
             
            if(scrollTop > 0){
                $('#wrapper').removeClass('expanded-top');
            }else{
                $('#wrapper').addClass('expanded-top');
            }
        
        });

        var calcStrength = function(clicked){
            // The List
            $('.forecast-days > li').each(function(){
                var val = $(this).find('.meta-' + clicked).text();
                var val = val.slice(0, -1);
                var forecast = $('.forecast-days');
                var highData = parseInt(forecast.attr('data-temp-high'));
                var lowData = parseInt(forecast.attr('data-temp-low'));

                if(clicked == 'high') {
                    var Str = calcAsc(val, highData);
                } else if(clicked == 'low') {
                    var Str = calcDsc(val, lowData);
                } else if(clicked == 'rain') {
                    var Str = calcPercent(val);
                }
                $(this).removeClass().addClass('str-' + Str);
                $('#top-wrap').removeClass().addClass('str-' + Str);
            });
         }
        
        /* MATH STUFF:  the following functions are here to find the strength to apply colors. */
        
            // function to clip ranges between 0 and 100
            function clip(num) {
                return (num > 100) ? 100 : (num < 0) ? 0 : num;
            }
            
            // return the correct strength classes function.
            var range = 5;
            function calcAsc(val, data) { // for highs.  highest temps highlighted
                var Normal = data; // get from api
                var NormalBottom = Normal - range; // bottom of range around normal temp
                var Percent = Math.round(parseInt((((val - NormalBottom)/(range*2))*100))/5)*5;

                return clip(Percent);
            }
            function calcDsc(val, data) { // for lows.  coldest temps get highlghted
                var Normal = data; // get from api
                var NormalTop = Normal + range; // top of range around normal temp
                var Percent = -(Math.round(parseInt((((NormalTop - val)/(range*2))*100))/5)*5);
                return clip(Percent);
            }
            function calcPercent(val) { // for standard percents
                var Percent = Math.round(parseInt(val)/5)*5;
                return clip(Percent);
            }
        
            /* handling the display of stuff */
            // change colors/focus when clicked in top header
            $(document).on('click', '.menu-focus li', function(){
                var clicked = $(this).text().toLowerCase();
                $('body').removeClass().addClass('display-' + clicked);
                
                calcStrength(clicked);
                
                // the top header changes when clicked?
                 
                $('#top-wrap').each(function(){
                    var val = $(this).find('.meta-' + clicked).text();
                    var val = val.slice(0, -1);
                    if(clicked == 'high') {
                        var Str = calcAsc(val);
                    } else if(clicked == 'low') {
                        var Str = calcDsc(val);
                    } else if(clicked == 'rain') {
                        var Str = calcPercent(val);
                    }
                    $(this).removeClass().addClass('str-' + Str);
                });
                
            });
            
        
        // @todo.  andrew, clean up the CSS and icons to match this list.
        var iconMap = {
            'clear' : 'Sun',
            'Sun' : 'Sun',
            'sunny' : 'Sun',
            'rain' : 'Cloud-Rain', 
            'chancetstorms' : 'Cloud-Lightning', 
            'chancestorms' : 'Cloud-Lightning',
            'tstorms' : 'Cloud-Lightning',
            'fog' : 'Cloud-Fog',
            'hazy' : 'Cloud-Fog',
            'mostlycloudy' : 'Cloud',
            'cloudy' : 'Cloud',
            'mostlysunny' : 'Cloud-Sun',
            'partlycloudy' : 'Cloud-Sun',
            'partlysunny' : 'Cloud-Sun',
            'chancerain' : 'Cloud-Drizzle',
            'windy' : 'Wind',
            'chanceflurries' : 'Cloud-Snow',
            'chancesleet' : 'Cloud-Hail',
            'sleet' : 'Cloud-Hail',
            'chancesnow' : 'Snowflake',
            'flurries' : 'Cloud-Snow',
            'snow' : 'Cloud-Snow',
            'unknown' : 'Cloud-Sun'
        };

        //compile templates
        var todayTemplate = Handlebars.compile($("#today-template").html());
        var forecastTemplate = Handlebars.compile($("#forecast-template").html());

        //render
        var render = function(data){
            var forecast = data.forecast;

            //render today
            forecast[0].icon = iconMap[forecast[0].icon]; //set proper icon for today
            $('#today').html(todayTemplate(forecast[0]));
            
            //render forecast
            forecast.splice(0, 1); //remove today
            //set proper icon class
            for(var i = 0; i < forecast.length; i++){ 
                forecast[i].icon = iconMap[forecast[i].icon];
            }
            var data = {forecast : forecast, almanac : data.almanac};
            $('#forecast').html(forecastTemplate(data));

            //calcStrength('high');
        };

        //get data
        navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;

            $.ajax({
                url : 'http://mattnull.simplecast.jit.su/weather?lat='+lat+'&lon='+lon,
                dataType : 'jsonp',
                success : function(data){ console.log(data)
                    render(data);
                }
            });
        });
        })
            app.initialize();
        </script>
    </body>
</html>
